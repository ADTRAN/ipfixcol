CC = @CC@
CFLAGS = @CFLAGS@
LIBS = @LIBS@
INCLUDE = "-I../../../"

prefix = @prefix@
exec_prefix = @exec_prefix@
datarootdir = @datarootdir@
datadir = @datadir@
bindir = @bindir@
includedir = @includedir@
libdir =  @libdir@
mandir = @mandir@

TARGETS = ipfixcol-dummy-output.so
TOPDIR = @CONFIGURE_PWD@
NAME = @PACKAGE_NAME@
RELEASE = @RELEASE@
INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
VERSION = $(shell cut -f1 $(TOPDIR)/VERSION | tr -d '\n')
DIR = "src/storage/dummy"

SRCS = dummy_output.c
OBJ = dummy_output.o

#documentation tools
XSLTPROC = @XSLTPROC@
XSLTMANSTYLE = @XSLTMANSTYLE@
MANSRCS = ipfixcol-dummy-output.dbk
MANPAGES = ipfixcol-dummy-output.1 

all: ipfixcol-dummy-output.so

ipfixcol-dummy-output.so: $(OBJ)
	$(CC) $(CFLAGS) $(LIBS) -shared -Wl,-soname,ipfixcol-dummy-output.so.1 -o $@ $< -lc

$(OBJ): $(SRCS)
	@for i in $(SRCS); do \
		$(CC) $(CFLAGS) $(INCLUDE) -fPIC -c $$i; \
	done;

clean:
	-rm -f $(TARGETS) $(OBJ) $(MANPAGES)

.PHONY: tarball-prepare
tarball-prepare:
	@for i in Makefile.in $(SRCS) $(MANSRCS); do \
		[ -d $(TOPDIR)/$(NAME)-$(VERSION)/$(DIR) ] || \
		mkdir -p $(TOPDIR)/$(NAME)-$(VERSION)/$(DIR) -p; \
		cp $$i $(TOPDIR)/$(NAME)-$(VERSION)/$(DIR)/$$i; \
	done;

.PHONY: install
install: $(TARGETS) man
	[ -d $(DESTDIR)/$(libdir) ] || \
		(mkdir -p $(DESTDIR)/$(libdir); chmod 755 $(DESTDIR)/$(libdir));
	$(INSTALL_PROGRAM) $(TARGETS) $(DESTDIR)/$(libdir)/;
	[ -d $(DESTDIR)/$(mandir)/man1 ] || \
		(mkdir -p $(DESTDIR)/$(mandir)/man1; chmod 755 $(DESTDIR)/$(mandir)/man1);
	$(INSTALL_DATA) $(MANPAGES) $(DESTDIR)/$(mandir)/man1/;

.PHONY: man
man: $(MANSRCS)
	@if [ -n "$(XSLTPROC)" ]; then \
		if [ -f "$(XSLTMANSTYLE)" ]; then \
			for i in $(MANSRCS); do \
				echo $(XSLTPROC) $(XSLTMANSTYLE) $$i; \
				$(XSLTPROC) $(XSLTMANSTYLE) $$i; \
			done; \
		else \
			echo "Missing $(XSLTMANSTYLE)!"; \
			exit 1; \
		fi \
	else \
		echo "Missing xsltproc"; \
	fi